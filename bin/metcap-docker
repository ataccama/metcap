#!/bin/sh

CFG_MAIN=/etc/metcap/main.conf
CFG_MUT=/etc/metcap/graphite_mutator.conf

if [ ! -e ${CFG_MAIN} ]; then
  cat <<-EOF > ${CFG_MAIN}
  syslog = false
  debug = false
  report_every = "${REPORT_EVERY}"

  [transport]
  type = "${TRANSPORT_TYPE}"
  buffer_size = ${TRANSPORT_SIZE}
EOF

  if [ "${TRANSPORT_TYPE}" == "redis" ]; then
    cat <<-EOF >> ${CFG_MAIN}
    redis_url = "${REDIS_URL}"
    redis_timeout = ${REDIS_TIMEOUT}
    redis_wait = ${REDIS_WAIT}
    redis_retries = ${REDIS_RETRIES}
    redis_connections = ${REDIS_CONNECTIONS}
    redis_queue = "${REDIS_QUEUE}"
EOF
  elif [ "${TRANSPORT_TYPE}" == "amqp" ]; then
    cat <<-EOF >> ${CFG_MAIN}
    amqp_url = "amqp://guest:guest@127.0.0.1:5672/"
    amqp_timeout = 5
    amqp_tag = "default"
    amqp_workers = 2
EOF
  fi

  if [ ${LISTENER_ENABLED} ]; then
    cat <<-EOF >> ${CFG_MAIN}
    [listener]
    [listener.influx]
    port = 8001
    protocol = "tcp"
    codec = "influx"
    decoders = ${LISTENER_DECODERS}
    [listener.graphite]
    port = 8002
    protocol = "tcp"
    codec = "graphite"
    decoders = ${LISTENER_DECODERS}
    mutator_file = "/etc/metcap/graphite_mutator.conf"
EOF
  fi

  if [ ${WRITER_ENABLED} ]; then
    cat <<-EOF >> ${CFG_MAIN}
    [writer]
    urls = [ "${WRITER_ES_URL}" ]
    timeout = ${WRITER_TIMEOUT}
    concurrency = ${WRITER_CONCURRENCY}
    bulk_max = ${WRITER_BULK_MAX}
    bulk_wait = "${WRITER_BULK_WAIT}"
    index = "${WRITER_INDEX}"
    doc_type = "${WRITER_DOC_TYPE}"
EOF
  fi
fi

if [ ! -e ${CFG_MUT} ]; then
  echo ${LISTENER_GRAPHITE_RULES} > ${CFG_MUT}
fi

exec /bin/metcap
